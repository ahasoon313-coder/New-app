<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Shifts</title>
<meta name="apple-mobile-web-app-title" content="My Shifts">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f2f2f7" id="meta-theme-color">

<link rel="apple-touch-icon" href="icon-v2.png">
<link rel="icon" type="image/png" href="icon-v2.png">

<style>
:root {
  --bg: #f2f2f7; --card: #ffffff; --text: #000000;
  --header-bg: #f2f2f7; --border: #e5e5ea;
  --primary: #007AFF; --highlight: #ff9500;
  --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
}
body.dark {
  --bg: #000000; --card: #1c1c1e; --text: #ffffff;
  --header-bg: #000000; --border: #38383a;
}

body {
  margin: 0; padding: 12px;
  font-family: var(--font-stack);
  background: var(--bg); color: var(--text);
  padding-bottom: 80px; /* Extra space for stats bar */
  transition: background 0.3s ease;
}

/* --- Controls --- */
.controls-area {
  display: grid; grid-template-columns: 1fr auto auto; gap: 8px;
  margin-bottom: 12px;
}
.row-btn { display: flex; gap: 8px; }

select, button {
  padding: 10px 14px; border-radius: 10px; font-size: 15px; border: none;
  font-weight: 600; cursor: pointer;
  background: var(--card); color: var(--text);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
button:active { transform: scale(0.96); }
.btn-icon { padding: 10px; min-width: 44px; }

/* --- Navigation --- */
.month-nav {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card); padding: 6px; border-radius: 12px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.month-nav h2 { margin: 0; font-size: 17px; font-weight: 700; cursor: pointer; }
.jump-hint { font-size: 10px; color: var(--primary); display: block; margin-top: 2px; }

/* Date Picker (Hidden by default) */
#datePickerContainer {
  display: none; position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
  background: var(--card); padding: 15px; border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 100; border: 1px solid var(--border);
  width: 250px;
}
#datePickerContainer.show { display: block; }
.picker-row { display: flex; gap: 10px; margin-bottom: 10px; }
.picker-row select { width: 100%; }

/* --- Calendar Wrapper --- */
.calendar-wrapper {
  background: var(--card); border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  overflow: hidden; border: 1px solid var(--border);
  position: relative;
  touch-action: pan-y; /* Allow vertical scroll, handle horizontal in JS */
}

.header, .row {
  display: grid;
  grid-template-columns: 70px repeat(5, 1fr);
  text-align: center; align-items: stretch;
}

/* FOCUS MODE */
.calendar-wrapper.focus-mode .header,
.calendar-wrapper.focus-mode .row {
  grid-template-columns: 85px 1fr;
}

.header {
  background: var(--header-bg); position: sticky; top: 0; z-index: 10;
  border-bottom: 1px solid var(--border);
  font-size: 13px; font-weight: 800; opacity: 0.9;
  backdrop-filter: blur(5px);
}
.header div { padding: 12px 0; }
.row { border-bottom: 1px solid var(--border); }

/* --- Date Cell --- */
.date-cell {
  display: flex; flex-direction: column; justify-content: center; align-items: center;
  font-weight: 700; font-size: 15px; padding: 6px 2px;
  background: var(--card); border-right: 1px solid var(--border);
}
.day-name { font-size: 10px; opacity: 0.5; font-weight: 500; text-transform: uppercase; }

/* Holiday Tags */
.holiday-tag {
  font-size: 9px; padding: 2px 4px; border-radius: 4px;
  margin-top: 3px; white-space: nowrap; overflow: hidden; max-width: 100%;
  color: white; font-weight: normal;
}
.ramadan-tag { background: #34c759; }
.eid-tag { background: #ff3b30; }

/* --- Shift Cells --- */
.shift-cell {
  display: flex; justify-content: center; align-items: center;
  font-weight: 600; font-size: 14px; padding: 10px 0;
}
.calendar-wrapper.focus-mode .shift-cell { font-size: 18px; font-weight: 700; }
.col-hidden { display: none; }

/* Colors */
.M { background: #ffe599; color: #5b4812; }
.A { background: #9fc5e8; color: #1e3f5e; }
.N { background: #8e7cc3; color: white; }
.O { background: transparent; color: var(--text); opacity: 0.3; }

body.dark .M { background: #665c3d; color: #fff; }
body.dark .A { background: #3a4e63; color: #fff; }
body.dark .N { background: #5a4f85; color: #fff; }

/* Markers */
.today-row .date-cell { color: var(--primary); }
.today-row { position: relative; }
.today-row::after {
  content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
  background: var(--primary);
}

/* --- STATISTICS BAR (Fixed Bottom) --- */
.stats-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: var(--card); border: 1px solid var(--border);
  padding: 10px 20px; border-radius: 50px;
  display: flex; gap: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  z-index: 100;
  font-size: 13px; font-weight: 600;
  white-space: nowrap;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-dot { width: 8px; height: 8px; border-radius: 50%; }

</style>
</head>

<body>

<div class="controls-area">
  <select id="groupSelect" onchange="saveGroup()">
    <option value="-1">All Groups</option>
    <option value="0">Group A</option>
    <option value="1">Group B</option>
    <option value="2">Group C</option>
    <option value="3">Group D</option>
    <option value="4">Group E</option>
  </select>
  
  <div class="row-btn">
    <button onclick="exportToCalendar()" class="btn-icon" style="background:#34c759; color:white">üìÖ</button>
    <button onclick="shareLink()" class="btn-icon">üîó</button>
    <button onclick="toggleLang()" class="btn-icon">üåê</button>
    <button onclick="toggleDark()" class="btn-icon">üåô</button>
  </div>
</div>

<div class="month-nav">
  <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
  <div style="text-align:center; cursor:pointer" onclick="toggleDatePicker()">
    <h2 id="monthTitle"></h2>
    <span class="jump-hint" id="jumpText">Tap to change date</span>
  </div>
  <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div id="datePickerContainer">
  <div class="picker-row">
    <select id="pickerMonth"></select>
    <select id="pickerYear"></select>
  </div>
  <button onclick="applyDate()" style="width:100%; background:var(--primary); color:white; padding:10px; border-radius:8px; border:none;">Go</button>
</div>

<div class="calendar-wrapper" id="calendarWrapper">
  <div class="header" id="calHeader"></div>
  <div id="calendarBody"></div>
</div>

<div class="stats-bar" id="statsBar" style="display:none">
  </div>

<script>
/* ---------- DATA ---------- */
const shiftCodes = ["M", "A", "N", "O", "O"];
const shiftNames = {
  en: { M: "Morning", A: "Afternoon", N: "Night", O: "Off" },
  ar: { M: "ÿµÿ®ÿßÿ≠", A: "ÿπÿµÿ±", N: "ŸÑŸäŸÑ", O: "ÿ±ÿßÿ≠ÿ©" }
};
const days = {
  en: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
  ar: ["ÿ£ÿ≠ÿØ", "ÿ•ÿ´ŸÜŸäŸÜ", "ÿ´ŸÑÿßÿ´ÿßÿ°", "ÿ£ÿ±ÿ®ÿπÿßÿ°", "ÿÆŸÖŸäÿ≥", "ÿ¨ŸÖÿπÿ©", "ÿ≥ÿ®ÿ™"]
};
// Stats Labels
const statLabels = {
  en: { M: "Morn", A: "Aft", N: "Night", O: "Off" },
  ar: { M: "ÿµÿ®ÿßÿ≠", A: "ÿπÿµÿ±", N: "ŸÑŸäŸÑ", O: "ÿ±ÿßÿ≠ÿ©" }
};

// Reference: 15 Jan 2026 => A=M
const referenceDate = new Date(2026, 0, 15);

// Holidays
const islamicEvents = {
  2026: {
    ramadanStart: "2026-02-18",
    ramadanEnd: "2026-03-19",
    eidFitr: "2026-03-20",
    arafah: "2026-05-26",
    eidAdha: "2026-05-27"
  }
};

/* ---------- STATE ---------- */
let currentDate = new Date();
let lang = localStorage.getItem("lang") || "en";
let dark = localStorage.getItem("dark") === "true";

/* ---------- URL HANDLING ---------- */
const params = new URLSearchParams(window.location.search);
const linkGroup = params.get("group");
if (linkGroup) {
  const map = { A: 0, B: 1, C: 2, D: 3, E: 4 };
  if (map[linkGroup.toUpperCase()] !== undefined) localStorage.setItem("group", map[linkGroup.toUpperCase()]);
}
const savedGroup = localStorage.getItem("group") ?? "-1";
groupSelect.value = savedGroup;
if (linkGroup) groupSelect.disabled = true;

/* ---------- SWIPE LOGIC ---------- */
let touchStartX = 0;
let touchEndX = 0;

const wrapper = document.getElementById("calendarWrapper");
wrapper.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
wrapper.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, false);

function handleSwipe() {
  if (touchEndX < touchStartX - 50) changeMonth(1); // Swipe Left -> Next
  if (touchEndX > touchStartX + 50) changeMonth(-1); // Swipe Right -> Prev
}

/* ---------- FUNCTIONS ---------- */
function updateThemeColor(isDark) {
  const themeMeta = document.getElementById("meta-theme-color");
  if (themeMeta) themeMeta.setAttribute("content", isDark ? "#000000" : "#f2f2f7");
}

function saveGroup() { localStorage.setItem("group", groupSelect.value); render(); }

function toggleLang() {
  lang = lang === "en" ? "ar" : "en";
  localStorage.setItem("lang", lang);
  render();
}

function toggleDark() {
  dark = !dark;
  localStorage.setItem("dark", dark);
  document.body.classList.toggle("dark");
  updateThemeColor(dark);
}

function changeMonth(n) {
  currentDate.setMonth(currentDate.getMonth() + n);
  render();
}

function shareLink() {
  const gVal = parseInt(groupSelect.value);
  const groups = ["A","B","C","D","E"];
  let url = window.location.href.split('?')[0];
  if (gVal !== -1) url += `?group=${groups[gVal]}`;
  navigator.clipboard.writeText(url).then(() => alert(lang === "ar" ? "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑!" : "Link copied!"));
}

/* --- EXPORT TO CALENDAR (ICS) --- */
function exportToCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const selected = parseInt(groupSelect.value);
  
  if(selected === -1) {
    alert(lang === "ar" ? "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¨ŸÖŸàÿπÿ© ÿ£ŸàŸÑÿßŸã" : "Please select a specific Group first.");
    return;
  }

  let icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MyShifts//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

  const shiftTimes = {
    M: { start: "070000", end: "150000" }, 
    A: { start: "140000", end: "220000" }, 
    N: { start: "220000", end: "060000" }, 
  };

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    date.setHours(0,0,0,0);
    
    const diff = Math.floor((date - referenceDate) / 86400000);
    const idx = ((diff + selected + 5) % 5 + 5) % 5;
    const code = shiftCodes[idx];

    if(code === "O" || !shiftTimes[code]) continue;
    const sTime = shiftTimes[code];
    
    // Format Date YYYYMMDD
    const yStr = date.getFullYear();
    const mStr = String(date.getMonth() + 1).padStart(2, '0');
    const dStr = String(date.getDate()).padStart(2, '0');
    const dateStr = `${yStr}${mStr}${dStr}`;

    icsContent += 
`BEGIN:VEVENT
SUMMARY:${shiftNames[lang][code]}
DTSTART:${dateStr}T${sTime.start}
DTEND:${dateStr}T${sTime.end}
DESCRIPTION:Shift Group ${["A","B","C","D","E"][selected]}
STATUS:CONFIRMED
END:VEVENT
`;
  }
  icsContent += "END:VCALENDAR";

  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.setAttribute('download', `shifts-${year}-${month+1}.ics`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* --- Date Picker Logic --- */
function toggleDatePicker() {
  const picker = document.getElementById("datePickerContainer");
  if (picker.style.display === "block") {
    picker.style.display = "none";
  } else {
    const mSel = document.getElementById("pickerMonth");
    const ySel = document.getElementById("pickerYear");
    mSel.innerHTML = ""; ySel.innerHTML = "";
    
    for(let i=0; i<12; i++) {
      let opt = document.createElement("option");
      opt.value = i;
      opt.innerText = new Date(2000, i, 1).toLocaleString(lang, {month:"short"});
      if(i === currentDate.getMonth()) opt.selected = true;
      mSel.appendChild(opt);
    }
    const cy = currentDate.getFullYear();
    for(let i=cy-5; i<=cy+5; i++) {
      let opt = document.createElement("option");
      opt.value = i;
      opt.innerText = i;
      if(i === cy) opt.selected = true;
      ySel.appendChild(opt);
    }
    picker.style.display = "block";
  }
}

function applyDate() {
  const m = parseInt(document.getElementById("pickerMonth").value);
  const y = parseInt(document.getElementById("pickerYear").value);
  currentDate = new Date(y, m, 1);
  document.getElementById("datePickerContainer").style.display = "none";
  render();
}

/* ---------- RENDER ENGINE ---------- */
function render() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const selected = parseInt(groupSelect.value);
  
  // Update Text
  monthTitle.innerText = currentDate.toLocaleString(lang, { month: "long", year: "numeric" });
  document.getElementById("jumpText").innerText = lang === "ar" ? "ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ" : "Tap to change date";

  // Focus Mode
  const wrap = document.getElementById("calendarWrapper");
  if (selected !== -1) wrap.classList.add("focus-mode");
  else wrap.classList.remove("focus-mode");

  // Header
  const groups = ["A", "B", "C", "D", "E"];
  let headerHTML = `<div>${lang==="ar"?"ÿ™ÿßÿ±ŸäÿÆ":"Date"}</div>`;
  groups.forEach((g, idx) => {
    const hidden = (selected !== -1 && selected !== idx) ? "col-hidden" : "";
    headerHTML += `<div class="${hidden}">${g}</div>`;
  });
  document.getElementById("calHeader").innerHTML = headerHTML;

  // Body & Stats Calculation
  const calBody = document.getElementById("calendarBody");
  calBody.innerHTML = "";
  
  const stats = { M:0, A:0, N:0, O:0 }; 
  
  const today = new Date(); today.setHours(0,0,0,0);
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const events = islamicEvents[year];

  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    date.setHours(0,0,0,0);
    
    // --- TIMEZONE FIX: Manual Format YYYY-MM-DD ---
    const yStr = date.getFullYear();
    const mStr = String(date.getMonth() + 1).padStart(2, '0');
    const dStr = String(date.getDate()).padStart(2, '0');
    const iso = `${yStr}-${mStr}-${dStr}`;
    // ----------------------------------------------

    // Holiday Logic
    let holidayName = "", holidayClass = "";
    if (events) {
      if (iso >= events.ramadanStart && iso <= events.ramadanEnd) {
        holidayName = lang === "ar" ? "ÿ±ŸÖÿ∂ÿßŸÜ" : "Ramadan"; holidayClass = "ramadan-tag";
      } else if (iso === events.eidFitr) {
        holidayName = lang === "ar" ? "ÿπŸäÿØ ÿßŸÑŸÅÿ∑ÿ±" : "Eid Fitr"; holidayClass = "eid-tag";
      } else if (iso === events.arafah || iso === events.eidAdha) {
        holidayName = lang === "ar" ? "ÿπŸäÿØ" : "Eid"; holidayClass = "eid-tag";
      }
    }

    const row = document.createElement("div");
    row.className = "row";
    if (date.getTime() === today.getTime()) row.classList.add("today-row");

    let tagHTML = holidayName ? `<div class="holiday-tag ${holidayClass}">${holidayName}</div>` : "";
    row.innerHTML = `<div class="date-cell"><span>${d}</span><span class="day-name">${days[lang][date.getDay()]}</span>${tagHTML}</div>`;

    const diff = Math.floor((date - referenceDate) / 86400000);
    
    // Render Shifts
    for (let g = 0; g < 5; g++) {
      const hidden = (selected !== -1 && selected !== g) ? "col-hidden" : "";
      
      const idx = ((diff + g + 5) % 5 + 5) % 5;
      const code = shiftCodes[idx];
      const shiftName = shiftNames[lang][code];

      // If this is the selected group (or viewing all), count stats
      if (selected === -1 || selected === g) {
        stats[code]++;
      }

      const cell = document.createElement("div");
      cell.className = `shift-cell ${code} ${hidden}`;
      cell.innerText = shiftName;
      row.appendChild(cell);
    }
    calBody.appendChild(row);
  }

  // Render Stats Bar (Only if a group is selected)
  const statsBar = document.getElementById("statsBar");
  if (selected !== -1) {
    statsBar.style.display = "flex";
    statsBar.innerHTML = `
      <div class="stat-item"><div class="stat-dot" style="background:#ffe599"></div> ${stats.M} ${statLabels[lang].M}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#9fc5e8"></div> ${stats.A} ${statLabels[lang].A}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#8e7cc3"></div> ${stats.N} ${statLabels[lang].N}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#ccc"></div> ${stats.O} ${statLabels[lang].O}</div>
    `;
  } else {
    statsBar.style.display = "none";
  }
}

/* ---------- INIT ---------- */
if (dark) document.body.classList.add("dark");
updateThemeColor(dark);
render();
</script>
</body>
</html>
