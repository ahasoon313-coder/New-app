<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Shifts Calendar</title>
<meta name="apple-mobile-web-app-title" content="My Shifts">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f2f2f7" id="meta-theme-color">

<link rel="apple-touch-icon" href="icon-v2.png">
<link rel="icon" type="image/png" href="icon-v2.png">

<style>
:root {
  --bg: #f2f2f7; --card: #ffffff; --text: #000000;
  --header-bg: #f2f2f7; --border: #e5e5ea;
  --primary: #007AFF; 
  --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
}
body.dark {
  --bg: #000000; --card: #1c1c1e; --text: #ffffff;
  --header-bg: #000000; --border: #38383a;
}

body {
  margin: 0; padding: 12px;
  font-family: var(--font-stack);
  background: var(--bg); color: var(--text);
  padding-bottom: 90px; /* Space for stats bar */
  transition: background 0.3s ease;
}

/* --- Controls --- */
.controls-area {
  display: grid; grid-template-columns: 1fr auto auto; gap: 8px;
  margin-bottom: 12px;
}
.row-btn { display: flex; gap: 8px; }

select, button {
  padding: 10px 14px; border-radius: 10px; font-size: 15px; border: none;
  font-weight: 600; cursor: pointer;
  background: var(--card); color: var(--text);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
button:active { transform: scale(0.96); }
.btn-icon { padding: 10px; min-width: 44px; }

/* --- Navigation --- */
.month-nav {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card); padding: 8px 12px; border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.month-nav h2 { margin: 0; font-size: 18px; font-weight: 700; cursor: pointer; }
.jump-hint { font-size: 10px; color: var(--primary); display: block; margin-top: 2px; }

/* --- GRID CALENDAR STRUCTURE --- */
.calendar-wrapper {
  background: var(--card); border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  overflow: hidden; border: 1px solid var(--border);
  position: relative;
  touch-action: pan-y;
}

/* 7 Column Grid */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr); /* 7 equal columns */
  text-align: center;
}

/* Day Names Header (Sun, Mon...) */
.day-names {
  background: var(--header-bg);
  border-bottom: 1px solid var(--border);
  font-weight: 700; color: var(--text); opacity: 0.6;
  font-size: 12px; padding: 10px 0;
}

/* Individual Day Cell */
.day-cell {
  aspect-ratio: 0.85; /* Makes them slightly tall squares */
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  position: relative;
  display: flex; flex-direction: column; 
  align-items: center; justify-content: flex-start;
  padding-top: 6px;
}
.day-cell:nth-child(7n) { border-right: none; } /* Remove right border on last col */

/* Date Number */
.date-num { font-size: 14px; font-weight: 600; z-index: 2; }
.today .date-num { 
  background: var(--primary); color: white; 
  border-radius: 50%; width: 24px; height: 24px; line-height: 24px;
}

/* Shift Text (M/A/N) */
.shift-text {
  font-size: 18px; font-weight: 800;
  margin-top: 4px; z-index: 2;
}

/* Holiday Bar (Bottom of cell) */
.holiday-bar {
  position: absolute; bottom: 4px; left: 2px; right: 2px;
  font-size: 8px; border-radius: 4px; padding: 2px 0;
  color: white; font-weight: bold;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ramadan-tag { background: #34c759; }
.eid-tag { background: #ff3b30; }

/* Shift Colors (Background of the whole cell) */
.M { background: #ffe599; color: #5b4812; }
.A { background: #9fc5e8; color: #1e3f5e; }
.N { background: #8e7cc3; color: white; }
.O { background: transparent; } /* Off days are clear */

body.dark .M { background: #665c3d; color: #fff; }
body.dark .A { background: #3a4e63; color: #fff; }
body.dark .N { background: #5a4f85; color: #fff; }

/* Empty cells for padding */
.empty-cell { background: var(--header-bg); opacity: 0.3; }

/* --- DATE PICKER --- */
#datePickerContainer {
  display: none; position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
  background: var(--card); padding: 15px; border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 100; border: 1px solid var(--border);
  width: 250px;
}
#datePickerContainer.show { display: block; }
.picker-row { display: flex; gap: 10px; margin-bottom: 10px; }
.picker-row select { width: 100%; }

/* --- STATS BAR --- */
.stats-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: var(--card); border: 1px solid var(--border);
  padding: 10px 20px; border-radius: 50px;
  display: flex; gap: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  z-index: 100; font-size: 13px; font-weight: 600; white-space: nowrap;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-dot { width: 8px; height: 8px; border-radius: 50%; }

</style>
</head>

<body>

<div class="controls-area">
  <select id="groupSelect" onchange="saveGroup()">
    <option value="-1">Select Group...</option> <option value="0">Group A</option>
    <option value="1">Group B</option>
    <option value="2">Group C</option>
    <option value="3">Group D</option>
    <option value="4">Group E</option>
  </select>
  
  <div class="row-btn">
    <button onclick="exportToCalendar()" class="btn-icon" style="background:#34c759; color:white">üìÖ</button>
    <button onclick="shareLink()" class="btn-icon">üîó</button>
    <button onclick="toggleLang()" class="btn-icon">üåê</button>
    <button onclick="toggleDark()" class="btn-icon">üåô</button>
  </div>
</div>

<div class="month-nav">
  <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
  <div style="text-align:center; cursor:pointer" onclick="toggleDatePicker()">
    <h2 id="monthTitle"></h2>
    <span class="jump-hint" id="jumpText">Tap to change date</span>
  </div>
  <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div id="datePickerContainer">
  <div class="picker-row"><select id="pickerMonth"></select><select id="pickerYear"></select></div>
  <button onclick="applyDate()" style="width:100%; background:var(--primary); color:white; padding:10px; border-radius:8px; border:none;">Go</button>
</div>

<div class="calendar-wrapper" id="calendarWrapper">
  <div class="calendar-grid day-names" id="daysHeader"></div>
  <div class="calendar-grid" id="calendarBody"></div>
</div>

<div class="stats-bar" id="statsBar" style="display:none"></div>

<script>
/* ---------- DATA ---------- */
const shiftCodes = ["M", "A", "N", "O", "O"];
// Short names for the Grid View (just 1 letter or short word)
const shiftShort = {
  en: { M: "M", A: "A", N: "N", O: "" },
  ar: { M: "ÿµ", A: "ÿπ", N: "ŸÑ", O: "" }
};
const shiftFull = {
  en: { M: "Morning", A: "Afternoon", N: "Night", O: "Off" },
  ar: { M: "ÿµÿ®ÿßÿ≠", A: "ÿπÿµÿ±", N: "ŸÑŸäŸÑ", O: "ÿ±ÿßÿ≠ÿ©" }
};
const days = {
  en: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
  ar: ["ÿ£ÿ≠ÿØ", "ÿ•ÿ´ŸÜŸäŸÜ", "ÿ´ŸÑÿßÿ´ÿßÿ°", "ÿ£ÿ±ÿ®ÿπÿßÿ°", "ÿÆŸÖŸäÿ≥", "ÿ¨ŸÖÿπÿ©", "ÿ≥ÿ®ÿ™"]
};
// Stats Labels
const statLabels = {
  en: { M: "Morn", A: "Aft", N: "Ngt", O: "Off" },
  ar: { M: "ÿµ", A: "ÿπ", N: "ŸÑ", O: "ÿ±" }
};

// Reference: 15 Jan 2026 => A=M
const referenceDate = new Date(2026, 0, 15);

// Holidays
const islamicEvents = {
  2026: {
    ramadanStart: "2026-02-18", ramadanEnd: "2026-03-19",
    eidFitrStart: "2026-03-20", eidFitrEnd: "2026-03-22",
    arafah: "2026-05-26",
    eidAdhaStart: "2026-05-27", eidAdhaEnd: "2026-05-30"
  }
};

/* ---------- STATE ---------- */
let currentDate = new Date();
let lang = localStorage.getItem("lang") || "en";
let dark = localStorage.getItem("dark") === "true";

/* ---------- INITIAL SETUP ---------- */
const params = new URLSearchParams(window.location.search);
const linkGroup = params.get("group");
if (linkGroup) {
  const map = { A: 0, B: 1, C: 2, D: 3, E: 4 };
  if (map[linkGroup.toUpperCase()] !== undefined) localStorage.setItem("group", map[linkGroup.toUpperCase()]);
}

// Default to -1 (All) if nothing saved
let savedGroup = localStorage.getItem("group");
if(savedGroup === null) savedGroup = "-1";

groupSelect.value = savedGroup;
if (linkGroup) groupSelect.disabled = true;

/* ---------- FUNCTIONS ---------- */
function updateThemeColor(isDark) {
  const themeMeta = document.getElementById("meta-theme-color");
  if (themeMeta) themeMeta.setAttribute("content", isDark ? "#000000" : "#f2f2f7");
}
function saveGroup() { localStorage.setItem("group", groupSelect.value); render(); }
function toggleLang() {
  lang = lang === "en" ? "ar" : "en";
  localStorage.setItem("lang", lang);
  render();
}
function toggleDark() {
  dark = !dark;
  localStorage.setItem("dark", dark);
  document.body.classList.toggle("dark");
  updateThemeColor(dark);
}
function changeMonth(n) {
  currentDate.setMonth(currentDate.getMonth() + n);
  render();
}
function shareLink() {
  const gVal = parseInt(groupSelect.value);
  const groups = ["A","B","C","D","E"];
  let url = window.location.href.split('?')[0];
  if (gVal !== -1) url += `?group=${groups[gVal]}`;
  navigator.clipboard.writeText(url).then(() => alert(lang === "ar" ? "ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑!" : "Link copied!"));
}

/* --- EXPORT FUNCTION --- */
function exportToCalendar() {
  const selected = parseInt(groupSelect.value);
  if(selected === -1) {
    alert(lang === "ar" ? "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¨ŸÖŸàÿπÿ© ÿ£ŸàŸÑÿßŸã" : "Please select a specific Group first.");
    return;
  }
  // (Simple export logic reused for brevity)
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyShifts//EN\n";
  const times = { M: "070000/150000", A: "140000/220000", N: "220000/060000" };
  
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    date.setHours(0,0,0,0);
    const diff = Math.floor((date - referenceDate) / 86400000);
    const idx = ((diff + selected + 5) % 5 + 5) % 5;
    const code = shiftCodes[idx];
    if(code === "O" || !times[code]) continue;
    
    const [startT, endT] = times[code].split('/');
    const yStr = date.getFullYear();
    const mStr = String(date.getMonth()+1).padStart(2,'0');
    const dStr = String(date.getDate()).padStart(2,'0');
    const ds = `${yStr}${mStr}${dStr}`;
    
    ics += `BEGIN:VEVENT\nSUMMARY:${shiftFull[lang][code]}\nDTSTART:${ds}T${startT}\nDTEND:${ds}T${endT}\nEND:VEVENT\n`;
  }
  ics += "END:VCALENDAR";
  const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `shifts.ics`;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

/* --- SWIPE --- */
let touchStartX = 0, touchEndX = 0;
const wrap = document.getElementById("calendarWrapper");
wrap.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
wrap.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  if(touchEndX < touchStartX - 50) changeMonth(1);
  if(touchEndX > touchStartX + 50) changeMonth(-1);
});

/* --- PICKER --- */
function toggleDatePicker() {
  const p = document.getElementById("datePickerContainer");
  p.classList.toggle("show");
  if(p.classList.contains("show")) {
    const mSel = document.getElementById("pickerMonth"), ySel = document.getElementById("pickerYear");
    mSel.innerHTML=""; ySel.innerHTML="";
    for(let i=0;i<12;i++) {
      let opt = new Option(new Date(2000, i, 1).toLocaleString(lang, {month:"short"}), i);
      if(i===currentDate.getMonth()) opt.selected=true; mSel.add(opt);
    }
    const cy = currentDate.getFullYear();
    for(let i=cy-5;i<=cy+5;i++){
      let opt = new Option(i, i);
      if(i===cy) opt.selected=true; ySel.add(opt);
    }
  }
}
function applyDate() {
  currentDate = new Date(document.getElementById("pickerYear").value, document.getElementById("pickerMonth").value, 1);
  document.getElementById("datePickerContainer").classList.remove("show");
  render();
}

/* ---------- RENDER GRID ---------- */
function render() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const selected = parseInt(groupSelect.value);
  
  monthTitle.innerText = currentDate.toLocaleString(lang, { month: "long", year: "numeric" });
  document.getElementById("jumpText").innerText = lang === "ar" ? "ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ" : "Tap to change date";

  // 1. Render Header (Days of week)
  const head = document.getElementById("daysHeader");
  head.innerHTML = "";
  days[lang].forEach(d => {
    const el = document.createElement("div");
    el.innerText = d.substring(0,3); // Shorten day name
    head.appendChild(el);
  });

  // 2. Render Body
  const body = document.getElementById("calendarBody");
  body.innerHTML = "";
  
  const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const events = islamicEvents[year];
  const today = new Date(); today.setHours(0,0,0,0);
  const stats = { M:0, A:0, N:0, O:0 };

  // Padding Cells (Empty days before the 1st)
  for(let i=0; i<firstDay; i++) {
    const empty = document.createElement("div");
    empty.className = "day-cell empty-cell";
    body.appendChild(empty);
  }

  // Day Cells
  for(let d=1; d<=daysInMonth; d++) {
    const date = new Date(year, month, d);
    date.setHours(0,0,0,0);
    const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    
    // Calculate Shift
    let shiftCode = "O"; // Default Off
    let shiftClass = "";
    
    if (selected !== -1) {
      const diff = Math.floor((date - referenceDate) / 86400000);
      const idx = ((diff + selected + 5) % 5 + 5) % 5;
      shiftCode = shiftCodes[idx];
      shiftClass = shiftCode; // Class controls background color
      stats[shiftCode]++;
    }

    // Holiday Check
    let hName = "", hClass = "";
    if (events) {
      if (iso >= events.ramadanStart && iso <= events.ramadanEnd) { hName = lang==="ar"?"ÿ±ŸÖÿ∂ÿßŸÜ":"Ramadan"; hClass="ramadan-tag"; }
      else if (iso >= events.eidFitrStart && iso <= events.eidFitrEnd) { hName = lang==="ar"?"ÿπŸäÿØ ÿßŸÑŸÅÿ∑ÿ±":"Eid Fitr"; hClass="eid-tag"; }
      else if (iso === events.arafah) { hName = lang==="ar"?"ÿπÿ±ŸÅÿ©":"Arafah"; hClass="eid-tag"; }
      else if (iso >= events.eidAdhaStart && iso <= events.eidAdhaEnd) { hName = lang==="ar"?"ÿπŸäÿØ ÿßŸÑÿ£ÿ∂ÿ≠Ÿâ":"Eid Adha"; hClass="eid-tag"; }
    }

    // Build Cell
    const cell = document.createElement("div");
    cell.className = `day-cell ${shiftClass}`;
    if(date.getTime() === today.getTime()) cell.classList.add("today");

    // Inner HTML
    let content = `<div class="date-num">${d}</div>`;
    
    // Only show shift Letter if a group is selected
    if(selected !== -1) {
      content += `<div class="shift-text">${shiftShort[lang][shiftCode]}</div>`;
    }
    
    if(hName) {
      content += `<div class="holiday-bar ${hClass}">${hName}</div>`;
    }

    cell.innerHTML = content;
    body.appendChild(cell);
  }

  // Update Stats Bar
  const statsBar = document.getElementById("statsBar");
  if (selected !== -1) {
    statsBar.style.display = "flex";
    statsBar.innerHTML = `
      <div class="stat-item"><div class="stat-dot" style="background:#ffe599"></div> ${stats.M} ${statLabels[lang].M}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#9fc5e8"></div> ${stats.A} ${statLabels[lang].A}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#8e7cc3"></div> ${stats.N} ${statLabels[lang].N}</div>
      <div class="stat-item"><div class="stat-dot" style="background:#ccc"></div> ${stats.O} ${statLabels[lang].O}</div>
    `;
  } else {
    statsBar.style.display = "none";
  }
}

// Init
if(dark) document.body.classList.add("dark");
updateThemeColor(dark);
render();

</script>
</body>
</html>
