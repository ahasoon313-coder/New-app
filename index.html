<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Shifts Pro +</title>
<meta name="apple-mobile-web-app-title" content="My Shifts">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f2f2f7" id="meta-theme-color">

<link rel="apple-touch-icon" href="icon-v2.png">
<link rel="icon" type="image/png" href="icon-v2.png">

<style>
:root {
  --bg: #f2f2f7; --card: #ffffff; --text: #000000;
  --header-bg: #f2f2f7; --border: #e5e5ea;
  --primary: #007AFF; 
  --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;

  /* DEFAULT COLORS */
  --col-M: #ffe599; --text-M: #5b4812;
  --col-A: #9fc5e8; --text-A: #1e3f5e;
  --col-N: #8e7cc3; --text-N: #ffffff;
  --col-SL: #ffb3b3; --text-SL: #b30000;
  --col-VL: #b3ffb3; --text-VL: #006600;
  --col-EL: #ffffb3; --text-EL: #999900;
}
body.dark {
  --bg: #000000; --card: #1c1c1e; --text: #ffffff;
  --header-bg: #000000; --border: #38383a;
}

body {
  margin: 0; padding: 12px;
  font-family: var(--font-stack);
  background: var(--bg); color: var(--text);
  padding-bottom: 100px; transition: background 0.3s ease;
  user-select: none; -webkit-tap-highlight-color: transparent;
}

/* --- Controls --- */
.controls-area {
  display: grid; grid-template-columns: 1fr auto auto; gap: 8px;
  margin-bottom: 12px;
}
.row-btn { display: flex; gap: 8px; }

select, button {
  padding: 10px 14px; border-radius: 10px; font-size: 15px; border: none;
  font-weight: 600; cursor: pointer;
  background: var(--card); color: var(--text);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
button:active { transform: scale(0.96); }
.btn-icon { padding: 10px; min-width: 44px; }

/* --- Navigation --- */
.month-nav {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card); padding: 8px 12px; border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.month-nav h2 { margin: 0; font-size: 18px; font-weight: 700; cursor: pointer; }
.jump-hint { font-size: 10px; color: var(--primary); display: block; margin-top: 2px; }

/* --- GRID CALENDAR --- */
.calendar-wrapper {
  background: var(--card); border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  overflow: hidden; border: 1px solid var(--border);
  position: relative; touch-action: pan-y;
}
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
.day-names {
  background: var(--header-bg); border-bottom: 1px solid var(--border);
  font-weight: 700; color: var(--text); opacity: 0.6;
  font-size: 12px; padding: 10px 0;
}
.day-cell {
  aspect-ratio: 0.8; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
  position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding-top: 6px; cursor: pointer;
}
.day-cell:active { opacity: 0.7; }
.day-cell:nth-child(7n) { border-right: none; }
.date-num { font-size: 14px; font-weight: 600; z-index: 2; pointer-events: none; }
.today .date-num { 
  background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px; line-height: 24px;
}
.shift-text { font-size: 18px; font-weight: 800; margin-top: 4px; z-index: 2; pointer-events: none; }

/* Holiday Bar */
.holiday-bar {
  position: absolute; bottom: 4px; left: 2px; right: 2px;
  font-size: 8px; border-radius: 4px; padding: 2px 0;
  color: white; font-weight: bold; white-space: nowrap; overflow: hidden; pointer-events: none;
}
.ramadan-tag { background: #34c759; }
.eid-tag { background: #ff3b30; }

/* DELAY BADGE (New) */
.delay-badge {
  position: absolute; top: 2px; right: 2px;
  background: #ff3b30; color: white;
  font-size: 9px; font-weight: bold;
  padding: 1px 4px; border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.3);
  z-index: 3;
}

/* --- DYNAMIC COLORS --- */
.M { background: var(--col-M); color: var(--text-M); }
.A { background: var(--col-A); color: var(--text-A); }
.N { background: var(--col-N); color: var(--text-N); }
.O { background: transparent; }
.SL { background: var(--col-SL) !important; color: var(--text-SL) !important; }
.VL { background: var(--col-VL) !important; color: var(--text-VL) !important; }
.EL { background: var(--col-EL) !important; color: var(--text-EL) !important; }

.empty-cell { background: var(--header-bg); opacity: 0.3; pointer-events: none; }

/* --- MODALS --- */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center;
}
.modal-overlay.show { display: flex; animation: fadeUp 0.2s ease-out; }
.modal-content {
  background: var(--card); width: 100%; max-width: 400px;
  border-top-left-radius: 20px; border-top-right-radius: 20px;
  padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
  max-height: 85vh; overflow-y: auto;
}
.modal-title { font-weight: bold; font-size: 18px; margin-bottom: 15px; text-align: center; }

@keyframes fadeUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.stat-box { 
  background: var(--bg); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); 
}
.stat-val { font-size: 20px; font-weight: 800; display: block; margin-bottom: 4px; }
.stat-lbl { font-size: 11px; opacity: 0.6; text-transform: uppercase; }

/* Settings */
.color-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
input[type="color"] { border: none; width: 40px; height: 30px; background: none; cursor: pointer; }

/* Actions */
.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.action-btn { padding: 15px; border-radius: 12px; font-weight: bold; border: 1px solid var(--border); background: var(--bg); color:var(--text);}

/* Bottom Bar */
.stats-bar {
  position: fixed; bottom: 20px; left: 20px; right: 20px;
  background: var(--card); border: 1px solid var(--border);
  padding: 12px; border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100; font-size: 12px; font-weight: 600;
  display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-dot { width: 8px; height: 8px; border-radius: 50%; }

</style>
</head>

<body>

<div class="controls-area">
  <select id="groupSelect" onchange="saveGroup()">
    <option value="-1">Select Group...</option>
    <option value="0">Group A</option>
    <option value="1">Group B</option>
    <option value="2">Group C</option>
    <option value="3">Group D</option>
    <option value="4">Group E</option>
  </select>
  
  <div class="row-btn">
    <button onclick="showYearlyStats()" class="btn-icon" style="background:#8e7cc3; color:white">üìä</button>
    <button onclick="openSettings()" class="btn-icon">‚öôÔ∏è</button>
  </div>
</div>

<div class="month-nav">
  <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
  <div style="text-align:center; cursor:pointer" onclick="toggleDatePicker()">
    <h2 id="monthTitle"></h2>
    <span class="jump-hint" id="jumpText"></span>
  </div>
  <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div class="calendar-wrapper" id="calendarWrapper">
  <div class="calendar-grid day-names" id="daysHeader"></div>
  <div class="calendar-grid" id="calendarBody"></div>
</div>

<div class="stats-bar" id="statsBar" style="display:none"></div>

<div id="settingsModal" class="modal-overlay" onclick="closeModal('settingsModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title">App Settings</div>
    <div class="action-grid" style="margin-bottom:20px;">
      <button onclick="toggleLang()" class="action-btn">Language üåê</button>
      <button onclick="toggleDark()" class="action-btn">Dark Mode üåô</button>
      <button onclick="exportToCalendar()" class="action-btn" style="grid-column:span 2">Export to Calendar üìÖ</button>
    </div>
    <div class="modal-title" style="font-size:14px; text-align:left">Customize Colors</div>
    <div id="colorList"></div>
    <button onclick="resetColors()" style="margin-top:15px; font-size:12px; color:red; background:none; border:none; width:100%">Reset to Default</button>
  </div>
</div>

<div id="yearlyModal" class="modal-overlay" onclick="closeModal('yearlyModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title" id="yearlyTitle">Yearly Report</div>
    
    <div class="stats-grid">
      <div class="stat-box" style="border-color:var(--primary)">
        <span class="stat-val" id="daysWorkedVal" style="color:var(--primary)">0</span>
        <span class="stat-lbl" id="daysWorkedLbl">ALREADY WORKED</span>
      </div>
      <div class="stat-box">
        <span class="stat-val" id="daysLeftVal">0</span>
        <span class="stat-lbl" id="daysLeftLbl">REMAINING</span>
      </div>
    </div>

    <div style="background:#fff0f0; padding:10px; border-radius:10px; margin-bottom:20px; border:1px solid #ffcccc; text-align:center;">
       <span style="font-size:20px; font-weight:bold; color:#d00000" id="totalDelayVal">0h 0m</span>
       <div style="font-size:10px; color:#d00000; opacity:0.7; font-weight:bold; margin-top:2px;">TOTAL LATENESS</div>
    </div>

    <div class="modal-title" style="font-size:14px; margin-top:10px;">Leaves (YTD)</div>
    <div class="stats-grid" id="leaveStatsGrid"></div>

    <div class="modal-title" style="font-size:14px; margin-top:10px;">Breakdown</div>
    <div id="yearlyBreakdown"></div>
    
    <button onclick="closeModal('yearlyModal')" style="width:100%; margin-top:20px; background:var(--border); padding:12px; border-radius:10px;">Close</button>
  </div>
</div>

<div id="datePickerContainer" class="modal-overlay" onclick="closeModal('datePickerContainer', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title">Jump to Date</div>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <select id="pickerMonth" style="flex:1"></select>
      <select id="pickerYear" style="flex:1"></select>
    </div>
    <button onclick="applyDate()" style="width:100%; background:var(--primary); color:white; padding:12px; border-radius:10px;">Go</button>
  </div>
</div>

<div id="leaveModal" class="modal-overlay" onclick="closeModal('leaveModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title" id="leaveModalTitle">Edit Day</div>
    
    <button onclick="promptDelay()" style="width:100%; margin-bottom:15px; background:#ff3b30; color:white; padding:15px; border-radius:12px; border:none; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px;">
      ‚è∞ Report Lateness / Delay
    </button>
    
    <div class="action-grid">
      <button class="action-btn" style="background:var(--col-SL)" onclick="setLeave('SL')">Sick ü§í</button>
      <button class="action-btn" style="background:var(--col-VL)" onclick="setLeave('VL')">Vacation üèñ</button>
      <button class="action-btn" style="background:var(--col-EL)" onclick="setLeave('EL')">Emergency üö®</button>
      <button class="action-btn" onclick="setLeave(null)">Clear Leaves üîÑ</button>
    </div>
    
    <button onclick="clearDelay()" style="margin-top:15px; background:none; border:none; color:red; width:100%; font-size:12px;">Clear Delay Only</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const shiftCodes = ["M", "A", "N", "O", "O"];
const shiftShort = { en: { M:"M", A:"A", N:"N", O:"", SL:"SL", VL:"VL", EL:"EL" }, ar: { M:"ÿµ", A:"ÿπ", N:"ŸÑ", O:"", SL:"ŸÖ", VL:"ÿ•", EL:"ÿ∑" } };
const days = { en: ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"], ar: ["ÿ£ÿ≠ÿØ","ÿ•ÿ´ŸÜŸäŸÜ","ÿ´ŸÑÿßÿ´ÿßÿ°","ÿ£ÿ±ÿ®ÿπÿßÿ°","ÿÆŸÖŸäÿ≥","ÿ¨ŸÖÿπÿ©","ÿ≥ÿ®ÿ™"] };
const statsLabels = { 
  en: { M:"Morning", A:"Afternoon", N:"Night", SL:"Sick", VL:"Vacation", EL:"Emerg" }, 
  ar: { M:"ÿµÿ®ÿßÿ≠", A:"ÿπÿµÿ±", N:"ŸÑŸäŸÑ", SL:"ŸÖÿ±ÿ∂Ÿäÿ©", VL:"ÿßÿ¨ÿßÿ≤ÿ©", EL:"ÿ∑ÿßÿ±ÿ¶ÿ©" } 
};
const colorKeys = ["M", "A", "N", "SL", "VL", "EL"];
const defaultColors = { M:"#ffe599", A:"#9fc5e8", N:"#8e7cc3", SL:"#ffb3b3", VL:"#b3ffb3", EL:"#ffffb3" };
const referenceDate = new Date(2026, 0, 15);
const islamicEvents = {
  2026: {
    ramadanStart: "2026-02-18", ramadanEnd: "2026-03-19",
    eidFitrStart: "2026-03-20", eidFitrEnd: "2026-03-22",
    arafah: "2026-05-26",
    eidAdhaStart: "2026-05-27", eidAdhaEnd: "2026-05-30"
  }
};

/* ---------- STATE ---------- */
let currentDate = new Date();
let lang = localStorage.getItem("lang") || "en";
let dark = localStorage.getItem("dark") === "true";
let userLeaves = JSON.parse(localStorage.getItem("leaves") || "{}");
let userDelays = JSON.parse(localStorage.getItem("delays") || "{}"); // Format: {"2026-01-20": 15}
let customColors = JSON.parse(localStorage.getItem("colors") || "{}");
let selectedDateISO = null;

/* ---------- INIT ---------- */
const params = new URLSearchParams(window.location.search);
if (params.get("group")) {
  const map = { A: 0, B: 1, C: 2, D: 3, E: 4 };
  if (map[params.get("group").toUpperCase()] !== undefined) localStorage.setItem("group", map[params.get("group").toUpperCase()]);
}
groupSelect.value = localStorage.getItem("group") || "-1";
if (params.get("group")) groupSelect.disabled = true;

/* ---------- CORE FUNCTIONS ---------- */
function initColors() {
  colorKeys.forEach(k => { document.documentElement.style.setProperty(`--col-${k}`, customColors[k] || defaultColors[k]); });
}
function updateColor(key, val) {
  customColors[key] = val; localStorage.setItem("colors", JSON.stringify(customColors));
  document.documentElement.style.setProperty(`--col-${key}`, val); render();
}
function resetColors() { customColors={}; localStorage.removeItem("colors"); initColors(); openSettings(); render(); }
function saveGroup() { localStorage.setItem("group", groupSelect.value); render(); }
function updateThemeColor(isDark) { const m=document.getElementById("meta-theme-color"); if(m) m.content=isDark?"#000000":"#f2f2f7"; }
function toggleLang() { lang=lang==="en"?"ar":"en"; localStorage.setItem("lang",lang); render(); }
function toggleDark() { dark=!dark; localStorage.setItem("dark",dark); document.body.classList.toggle("dark"); updateThemeColor(dark); }
function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); render(); }
function closeModal(id,e) { if(!e || e.target===e.currentTarget) document.getElementById(id).classList.remove("show"); }

/* ---------- DELAY LOGIC ---------- */
function promptDelay() {
  if(!selectedDateISO) return;
  const current = userDelays[selectedDateISO] || "";
  const mins = prompt(lang==="ar"?"ÿ£ÿØÿÆŸÑ ÿØŸÇÿßÿ¶ŸÇ ÿßŸÑÿ™ÿ£ÿÆŸäÿ±:":"Enter delay in minutes:", current);
  if(mins !== null) {
    const val = parseInt(mins);
    if(val > 0) userDelays[selectedDateISO] = val;
    else delete userDelays[selectedDateISO];
    localStorage.setItem("delays", JSON.stringify(userDelays));
    document.getElementById("leaveModal").classList.remove("show");
    render();
  }
}
function clearDelay() {
  if(selectedDateISO && userDelays[selectedDateISO]) {
    delete userDelays[selectedDateISO];
    localStorage.setItem("delays", JSON.stringify(userDelays));
    document.getElementById("leaveModal").classList.remove("show");
    render();
  }
}

/* ---------- SETTINGS MODAL ---------- */
function openSettings() {
  const list = document.getElementById("colorList"); list.innerHTML = "";
  colorKeys.forEach(k => {
    const c = customColors[k] || defaultColors[k];
    list.innerHTML += `<div class="color-row"><span>${statsLabels[lang][k]}</span><input type="color" value="${c}" onchange="updateColor('${k}',this.value)"></div>`;
  });
  document.getElementById("settingsModal").classList.add("show");
}

/* ---------- YEARLY STATS ---------- */
function showYearlyStats() {
  const selected = parseInt(groupSelect.value);
  if(selected===-1) { alert(lang==="ar"?"ÿßÿÆÿ™ÿ± ŸÖÿ¨ŸÖŸàÿπÿ© ÿ£ŸàŸÑÿßŸã":"Select Group First"); return; }

  const year = currentDate.getFullYear();
  const today = new Date(); today.setHours(0,0,0,0);
  let daysWorked=0, daysLeft=0, totalDelayMins=0;
  const stats = { M:0, A:0, N:0, SL:0, VL:0, EL:0 };
  const isLeap = (year%4===0 && year%100!==0)||(year%400===0);
  const totalDays = isLeap?366:365;

  for(let d=1; d<=totalDays; d++) {
    const date = new Date(year, 0, d);
    const iso = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    
    let code = "O";
    if(userLeaves[iso]) code = userLeaves[iso];
    else {
      const diff = Math.floor((date-referenceDate)/86400000);
      code = shiftCodes[((diff+selected+5)%5+5)%5];
    }
    const isPast = date < today;
    if(code!=="O") {
      if(isPast) { daysWorked++; if(stats[code]!==undefined) stats[code]++; }
      else daysLeft++;
    }
    // Count Delay
    if(userDelays[iso]) totalDelayMins += userDelays[iso];
  }

  // Formatting Time
  const h = Math.floor(totalDelayMins/60);
  const m = totalDelayMins%60;
  
  document.getElementById("yearlyTitle").innerText = `${year} Report`;
  document.getElementById("daysWorkedVal").innerText = daysWorked;
  document.getElementById("daysWorkedLbl").innerText = lang==="ar"?"ÿ£ŸäÿßŸÖ ÿπŸÖŸÑ ŸÖŸÜÿ¨ÿ≤ÿ©":"DAYS ATTENDED";
  document.getElementById("daysLeftVal").innerText = daysLeft;
  document.getElementById("daysLeftLbl").innerText = lang==="ar"?"ÿ¥ŸÅÿ™ÿßÿ™ ŸÖÿ™ÿ®ŸÇŸäÿ©":"SHIFTS REMAINING";
  document.getElementById("totalDelayVal").innerText = `${h}h ${m}m`;

  document.getElementById("leaveStatsGrid").innerHTML = `
    <div class="stat-box" style="background:var(--col-SL)"><span class="stat-val">${stats.SL}</span><span class="stat-lbl">${statsLabels[lang].SL}</span></div>
    <div class="stat-box" style="background:var(--col-VL)"><span class="stat-val">${stats.VL}</span><span class="stat-lbl">${statsLabels[lang].VL}</span></div>
    <div class="stat-box" style="background:var(--col-EL)"><span class="stat-val">${stats.EL}</span><span class="stat-lbl">${statsLabels[lang].EL}</span></div>
  `;
  document.getElementById("yearlyBreakdown").innerHTML = `
    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #ccc"><span>${statsLabels[lang].M}</span> <strong>${stats.M}</strong></div>
    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #ccc"><span>${statsLabels[lang].A}</span> <strong>${stats.A}</strong></div>
    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #ccc"><span>${statsLabels[lang].N}</span> <strong>${stats.N}</strong></div>
  `;
  document.getElementById("yearlyModal").classList.add("show");
}

/* ---------- LEAVES & DATE PICKER ---------- */
function openLeaveModal(iso,d) { if(parseInt(groupSelect.value)===-1)return; selectedDateISO=iso; document.getElementById("leaveModalTitle").innerText=`${d} - Edit`; document.getElementById("leaveModal").classList.add("show"); }
function setLeave(t) { if(!selectedDateISO)return; if(t===null)delete userLeaves[selectedDateISO]; else userLeaves[selectedDateISO]=t; localStorage.setItem("leaves",JSON.stringify(userLeaves)); document.getElementById("leaveModal").classList.remove("show"); render(); }
function toggleDatePicker() { document.getElementById("datePickerContainer").classList.add("show"); const m=document.getElementById("pickerMonth"),y=document.getElementById("pickerYear"); m.innerHTML=""; y.innerHTML=""; for(let i=0;i<12;i++) m.add(new Option(new Date(2000,i,1).toLocaleString(lang,{month:"short"}),i)); const cy=currentDate.getFullYear(); for(let i=cy-5;i<=cy+5;i++) y.add(new Option(i,i)); m.value=currentDate.getMonth(); y.value=cy; }
function applyDate() { currentDate=new Date(document.getElementById("pickerYear").value,document.getElementById("pickerMonth").value,1); document.getElementById("datePickerContainer").classList.remove("show"); render(); }

/* ---------- EXPORT ---------- */
function exportToCalendar() {
  const selected=parseInt(groupSelect.value); if(selected===-1){alert("Select Group");return;}
  const year=currentDate.getFullYear(), month=currentDate.getMonth(), daysInMonth=new Date(year,month+1,0).getDate();
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyShifts//EN\n";
  const times={M:"070000/150000",A:"140000/220000",N:"220000/060000"};
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d); const iso=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    let code=userLeaves[iso]?userLeaves[iso]:shiftCodes[((Math.floor((date-referenceDate)/86400000)+selected+5)%5+5)%5];
    if(["O","SL","VL","EL"].includes(code))continue;
    const [s,e]=times[code].split('/'); const ds=iso.replace(/-/g,'');
    ics+=`BEGIN:VEVENT\nSUMMARY:Shift ${code}\nDTSTART:${ds}T${s}\nDTEND:${ds}T${e}\nEND:VEVENT\n`;
  }
  ics+="END:VCALENDAR";
  const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'})); link.download="shifts.ics"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

/* ---------- RENDER ---------- */
function render() {
  const year=currentDate.getFullYear(), month=currentDate.getMonth(), selected=parseInt(groupSelect.value);
  monthTitle.innerText=currentDate.toLocaleString(lang,{month:"long",year:"numeric"});
  document.getElementById("jumpText").innerText=lang==="ar"?"ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ":"Tap to change date";
  const head=document.getElementById("daysHeader"); head.innerHTML=""; days[lang].forEach(d=>{const el=document.createElement("div");el.innerText=d.substring(0,3);head.appendChild(el);});
  const body=document.getElementById("calendarBody"); body.innerHTML="";
  const firstDay=new Date(year,month,1).getDay(), daysInMonth=new Date(year,month+1,0).getDate();
  const today=new Date(); today.setHours(0,0,0,0); const events=islamicEvents[year];
  const stats={M:0,A:0,N:0,SL:0,VL:0,EL:0};
  for(let i=0;i<firstDay;i++)body.appendChild(document.createElement("div"));
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d); date.setHours(0,0,0,0);
    const iso=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let displayCode="O";
    if(selected!==-1){
      if(userLeaves[iso]) displayCode=userLeaves[iso];
      else displayCode=shiftCodes[((Math.floor((date-referenceDate)/86400000)+selected+5)%5+5)%5];
      if(stats[displayCode]!==undefined) stats[displayCode]++;
    }
    let hName="",hClass=""; if(events){ if(iso>=events.ramadanStart&&iso<=events.ramadanEnd){hName="Ramadan";hClass="ramadan-tag";}else if(iso>=events.eidFitrStart&&iso<=events.eidFitrEnd){hName="Eid Fitr";hClass="eid-tag";}else if(iso===events.arafah){hName="Arafah";hClass="eid-tag";}else if(iso>=events.eidAdhaStart&&iso<=events.eidAdhaEnd){hName="Eid Adha";hClass="eid-tag";} }
    
    const cell=document.createElement("div"); cell.className=`day-cell ${displayCode}`;
    if(date.getTime()===today.getTime()) cell.classList.add("today");
    cell.onclick=()=>openLeaveModal(iso,d);
    
    let content=`<div class="date-num">${d}</div>`;
    if(selected!==-1 && displayCode!=="O") content+=`<div class="shift-text">${shiftShort[lang][displayCode]}</div>`;
    if(hName) content+=`<div class="holiday-bar ${hClass}">${hName}</div>`;
    
    // RENDER DELAY BADGE
    if(userDelays[iso]) content+=`<div class="delay-badge">${userDelays[iso]}m</div>`;

    cell.innerHTML=content; body.appendChild(cell);
  }
  const statsBar=document.getElementById("statsBar");
  if(selected!==-1){
    statsBar.style.display="flex";
    let html=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-M)"></div>${stats.M}</div><div class="stat-item"><div class="stat-dot" style="background:var(--col-A)"></div>${stats.A}</div><div class="stat-item"><div class="stat-dot" style="background:var(--col-N)"></div>${stats.N}</div>`;
    if(stats.SL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-SL)"></div>${stats.SL}</div>`;
    if(stats.VL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-VL)"></div>${stats.VL}</div>`;
    if(stats.EL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-EL)"></div>${stats.EL}</div>`;
    statsBar.innerHTML=html;
  }else{statsBar.style.display="none";}
}

/* ---------- START ---------- */
if(dark)document.body.classList.add("dark");
initColors(); updateThemeColor(dark); render();
let tx=0, te=0; document.getElementById("calendarWrapper").addEventListener('touchstart',e=>tx=e.changedTouches[0].screenX); document.getElementById("calendarWrapper").addEventListener('touchend',e=>{te=e.changedTouches[0].screenX; if(te<tx-50)changeMonth(1); if(te>tx+50)changeMonth(-1);});
</script>
</body>
</html>
