<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Shifts Ultimate</title>
<meta name="apple-mobile-web-app-title" content="My Shifts">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#f2f2f7" id="meta-theme-color">

<link rel="apple-touch-icon" href="icon-v2.png">
<link rel="icon" type="image/png" href="icon-v2.png">

<style>
:root {
  --bg: #f2f2f7; --card: #ffffff; --text: #000000;
  --header-bg: #f2f2f7; --border: #e5e5ea;
  --primary: #007AFF; 

  /* COLORS */
  --col-M: #ffe599; --text-M: #5b4812;
  --col-A: #9fc5e8; --text-A: #1e3f5e;
  --col-N: #8e7cc3; --text-N: #ffffff;
  --col-SL: #ffb3b3; --text-SL: #b30000;
  --col-VL: #b3ffb3; --text-VL: #006600;
  --col-EL: #ffffb3; --text-EL: #999900;
}
body.dark {
  --bg: #000000; --card: #1c1c1e; --text: #ffffff;
  --header-bg: #000000; --border: #38383a;
}

body {
  margin: 0; padding: 12px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, sans-serif;
  background: var(--bg); color: var(--text);
  padding-bottom: 100px; transition: background 0.3s ease;
  user-select: none; -webkit-tap-highlight-color: transparent;
}

/* --- UI COMPONENTS --- */
.controls-area { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; margin-bottom: 12px; }
.row-btn { display: flex; gap: 8px; }

select, button {
  padding: 10px 14px; border-radius: 10px; font-size: 15px; border: none;
  font-weight: 600; cursor: pointer;
  background: var(--card); color: var(--text);
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
button:active { transform: scale(0.96); }
.btn-icon { padding: 10px; min-width: 44px; }

.permission-bar {
  background: var(--primary); color: white;
  padding: 8px; border-radius: 8px; margin-bottom: 10px;
  text-align: center; font-size: 13px; font-weight: bold;
  display: flex; justify-content: space-between; padding-left: 15px; padding-right: 15px;
}

.month-nav {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--card); padding: 8px 12px; border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.month-nav h2 { margin: 0; font-size: 18px; font-weight: 700; cursor: pointer; }
.jump-hint { font-size: 10px; color: var(--primary); display: block; margin-top: 2px; }

/* --- CALENDAR --- */
.calendar-wrapper {
  background: var(--card); border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  overflow: hidden; border: 1px solid var(--border);
  position: relative; touch-action: pan-y;
}
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
.day-names {
  background: var(--header-bg); border-bottom: 1px solid var(--border);
  font-weight: 700; color: var(--text); opacity: 0.6;
  font-size: 12px; padding: 10px 0;
}
.day-cell {
  aspect-ratio: 0.8; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
  position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding-top: 6px; cursor: pointer;
}
.day-cell:nth-child(7n) { border-right: none; }

/* TODAY HIGHLIGHT */
.day-cell.today {
  box-shadow: inset 0 0 0 4px var(--primary); /* Thick blue frame */
  z-index: 5;
}

.date-num { font-size: 14px; font-weight: 600; z-index: 2; pointer-events: none; }
.today .date-num { 
  color: var(--primary); 
}
.shift-text { font-size: 18px; font-weight: 800; margin-top: 4px; z-index: 2; pointer-events: none; }

.holiday-bar {
  position: absolute; bottom: 4px; left: 2px; right: 2px;
  font-size: 8px; border-radius: 4px; padding: 2px 0;
  color: white; font-weight: bold; white-space: nowrap; overflow: hidden; pointer-events: none;
}
.ramadan-tag { background: #34c759; }
.eid-tag { background: #ff3b30; }

.badge-container { position: absolute; top: 2px; right: 2px; display: flex; flex-direction: column; gap: 2px; z-index: 5; }
.badge { font-size: 8px; font-weight: bold; padding: 1px 4px; border-radius: 4px; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.3); }
.badge-delay { background: #ff3b30; } 
.badge-perm { background: #007AFF; }

/* COLORS */
.M { background: var(--col-M); color: var(--text-M); }
.A { background: var(--col-A); color: var(--text-A); }
.N { background: var(--col-N); color: var(--text-N); }
.O { background: transparent; }
.SL { background: var(--col-SL) !important; color: var(--text-SL) !important; }
.VL { background: var(--col-VL) !important; color: var(--text-VL) !important; }
.EL { background: var(--col-EL) !important; color: var(--text-EL) !important; }
.empty-cell { background: var(--header-bg); opacity: 0.3; pointer-events: none; }

/* MODALS */
.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center;
}
.modal-overlay.show { display: flex; animation: fadeUp 0.2s ease-out; }
.modal-content {
  background: var(--card); width: 100%; max-width: 400px;
  border-top-left-radius: 20px; border-top-right-radius: 20px;
  padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
  max-height: 85vh; overflow-y: auto;
}
.modal-title { font-weight: bold; font-size: 18px; margin-bottom: 15px; text-align: center; }
@keyframes fadeUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* STATS */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.stat-box { background: var(--bg); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
.stat-val { font-size: 20px; font-weight: 800; display: block; margin-bottom: 4px; }
.stat-lbl { font-size: 11px; opacity: 0.6; text-transform: uppercase; }

.manual-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; }
.manual-input { width: 60px; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); text-align: center; font-weight: bold; }
.color-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
input[type="color"] { border: none; width: 40px; height: 30px; background: none; cursor: pointer; }

.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.action-btn { padding: 15px; border-radius: 12px; font-weight: bold; border: 1px solid var(--border); background: var(--bg); color:var(--text); }

.stats-bar {
  position: fixed; bottom: 20px; left: 20px; right: 20px;
  background: var(--card); border: 1px solid var(--border);
  padding: 12px; border-radius: 16px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100; font-size: 12px; font-weight: 600;
  display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
}
.stat-item { display: flex; align-items: center; gap: 4px; }
.stat-dot { width: 8px; height: 8px; border-radius: 50%; }

/* FILE INPUT HIDDEN */
#fileInput { display: none; }
</style>
</head>

<body>

<div class="controls-area">
  <select id="groupSelect" onchange="saveGroup()">
    <option value="-1">Select Group...</option>
    <option value="0">Group A</option>
    <option value="1">Group B</option>
    <option value="2">Group C</option>
    <option value="3">Group D</option>
    <option value="4">Group E</option>
  </select>
  <div class="row-btn">
    <button onclick="showYearlyStats()" class="btn-icon" style="background:#8e7cc3; color:white">üìä</button>
    <button onclick="openSettings()" class="btn-icon">‚öôÔ∏è</button>
  </div>
</div>

<div class="permission-bar" id="permBar" style="display:none">
  <span>Month Balance (12h):</span><span id="permLeft">12h Remaining</span>
</div>

<div class="month-nav">
  <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
  <div style="text-align:center; cursor:pointer" onclick="toggleDatePicker()">
    <h2 id="monthTitle"></h2>
    <span class="jump-hint" id="jumpText"></span>
  </div>
  <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div class="calendar-wrapper" id="calendarWrapper">
  <div class="calendar-grid day-names" id="daysHeader"></div>
  <div class="calendar-grid" id="calendarBody"></div>
</div>

<div class="stats-bar" id="statsBar" style="display:none"></div>

<div id="settingsModal" class="modal-overlay" onclick="closeModal('settingsModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title">App Settings</div>
    <div class="action-grid" style="margin-bottom:20px;">
      <button onclick="toggleLang()" class="action-btn">Language üåê</button>
      <button onclick="toggleDark()" class="action-btn">Dark Mode üåô</button>
      <button onclick="exportToCalendar()" class="action-btn" style="grid-column:span 2">Export to Calendar üìÖ</button>
    </div>

    <div class="modal-title" style="font-size:14px; text-align:left; color:var(--primary);">Data Backup</div>
    <div class="action-grid" style="margin-bottom:20px;">
      <button onclick="backupData()" class="action-btn" style="background:#34c759; color:white; border:none;">Download Backup üì•</button>
      <button onclick="document.getElementById('fileInput').click()" class="action-btn" style="background:#ff9500; color:white; border:none;">Restore Data üì§</button>
      <input type="file" id="fileInput" accept=".json" onchange="restoreData(this)">
    </div>

    <div class="modal-title" style="font-size:14px; text-align:left; color:var(--primary);">Manual / Previous Records</div>
    <div style="background:var(--bg); padding:10px; border-radius:10px; margin-bottom:20px;">
       <div class="manual-row"><span>Sick Leaves:</span><input type="number" id="manSL" class="manual-input" placeholder="0" onchange="saveManual()"></div>
       <div class="manual-row"><span>Emergency:</span><input type="number" id="manEL" class="manual-input" placeholder="0" onchange="saveManual()"></div>
       <div class="manual-row"><span>Permission (Month):</span><input type="number" id="manPerm" class="manual-input" placeholder="Hrs" onchange="saveManual()"></div>
    </div>

    <div class="modal-title" style="font-size:14px; text-align:left">Customize Colors</div>
    <div id="colorList" style="margin-bottom:15px;"></div>
    
    <button onclick="resetColors()" style="font-size:12px; color:red; background:none; border:none; width:100%">Reset Colors</button>
  </div>
</div>

<div id="yearlyModal" class="modal-overlay" onclick="closeModal('yearlyModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title" id="yearlyTitle">Yearly Report</div>
    <div class="stats-grid">
      <div class="stat-box" style="border-color:var(--primary)"><span class="stat-val" id="daysWorkedVal" style="color:var(--primary)">0</span><span class="stat-lbl" id="daysWorkedLbl">ATTENDED</span></div>
      <div class="stat-box"><span class="stat-val" id="daysLeftVal">0</span><span class="stat-lbl" id="daysLeftLbl">REMAINING</span></div>
    </div>
    <div class="stats-grid">
      <div class="stat-box" style="background:#f0f8ff; border-color:#007AFF;"><span class="stat-val" id="totalPermVal" style="color:#007AFF">0h</span><span class="stat-lbl">PERMISSIONS</span></div>
      <div class="stat-box" style="background:#fff0f0; border-color:#ff3b30;"><span class="stat-val" id="totalDelayVal" style="color:#ff3b30">0m</span><span class="stat-lbl">LATENESS</span></div>
    </div>
    <div class="stats-grid" id="leaveStatsGrid"></div>
    <button onclick="closeModal('yearlyModal')" style="width:100%; margin-top:20px; background:var(--border); padding:12px; border-radius:10px;">Close</button>
  </div>
</div>

<div id="datePickerContainer" class="modal-overlay" onclick="closeModal('datePickerContainer', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title">Jump to Date</div>
    <div style="display:flex; gap:10px; margin-bottom:15px;"><select id="pickerMonth" style="flex:1"></select><select id="pickerYear" style="flex:1"></select></div>
    <button onclick="applyDate()" style="width:100%; background:var(--primary); color:white; padding:12px; border-radius:10px;">Go</button>
  </div>
</div>

<div id="leaveModal" class="modal-overlay" onclick="closeModal('leaveModal', event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-title" id="leaveModalTitle">Edit Day</div>
    
    <div class="action-grid" style="margin-bottom:15px;">
      <button onclick="promptPermission()" style="background:#007AFF; color:white; padding:12px; border-radius:10px; border:none; font-weight:bold;">‚è± Permission</button>
      <button onclick="promptDelay()" style="background:#ff3b30; color:white; padding:12px; border-radius:10px; border:none; font-weight:bold;">üò° Late</button>
    </div>

    <div class="modal-title" style="font-size:12px; margin-bottom:5px;">Set Leave Status:</div>
    <div class="action-grid" style="margin-bottom:15px;">
      <button class="action-btn" style="background:var(--col-SL)" onclick="setLeave('SL')">Sick ü§í</button>
      <button class="action-btn" style="background:var(--col-VL)" onclick="setLeave('VL')">Vacation üèñ</button>
      <button class="action-btn" style="background:var(--col-EL)" onclick="setLeave('EL')">Emergency üö®</button>
      <button class="action-btn" onclick="setLeave(null)">Reset üîÑ</button>
    </div>
    
    <div style="display:flex; gap:10px; margin-top:5px;">
       <button onclick="clearTimeData('perm')" style="flex:1; font-size:10px; color:#007AFF; border:1px solid #007AFF; padding:5px; border-radius:6px; background:none;">Reset Perm</button>
       <button onclick="clearTimeData('delay')" style="flex:1; font-size:10px; color:#ff3b30; border:1px solid #ff3b30; padding:5px; border-radius:6px; background:none;">Reset Delay</button>
    </div>
  </div>
</div>

<script>
/* CONFIG */
const shiftCodes = ["M", "A", "N", "O", "O"];
const shiftShort = { en: { M:"M", A:"A", N:"N", O:"", SL:"SL", VL:"VL", EL:"EL" }, ar: { M:"ÿµ", A:"ÿπ", N:"ŸÑ", O:"", SL:"ŸÖ", VL:"ÿ•", EL:"ÿ∑" } };
const days = { en: ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"], ar: ["ÿ£ÿ≠ÿØ","ÿ•ÿ´ŸÜŸäŸÜ","ÿ´ŸÑÿßÿ´ÿßÿ°","ÿ£ÿ±ÿ®ÿπÿßÿ°","ÿÆŸÖŸäÿ≥","ÿ¨ŸÖÿπÿ©","ÿ≥ÿ®ÿ™"] };
const statsLabels = { en: { M:"Morning", A:"Afternoon", N:"Night", SL:"Sick", VL:"Vacation", EL:"Emerg" }, ar: { M:"ÿµÿ®ÿßÿ≠", A:"ÿπÿµÿ±", N:"ŸÑŸäŸÑ", SL:"ŸÖÿ±ÿ∂Ÿäÿ©", VL:"ÿßÿ¨ÿßÿ≤ÿ©", EL:"ÿ∑ÿßÿ±ÿ¶ÿ©" } };
const colorKeys = ["M", "A", "N", "SL", "VL", "EL"];
const defaultColors = { M:"#ffe599", A:"#9fc5e8", N:"#8e7cc3", SL:"#ffb3b3", VL:"#b3ffb3", EL:"#ffffb3" };
const referenceDate = new Date(2026, 0, 15);
const appStartDate = new Date(2026, 0, 15); // COUNT STATS FROM JAN 15

const islamicEvents = {
  2026: {
    ramadanStart: "2026-02-18", ramadanEnd: "2026-03-19",
    eidFitrStart: "2026-03-20", eidFitrEnd: "2026-03-22",
    arafah: "2026-05-26",
    eidAdhaStart: "2026-05-27", eidAdhaEnd: "2026-05-30"
  }
};

/* STATE */
let currentDate = new Date();
let lang = localStorage.getItem("lang") || "en";
let dark = localStorage.getItem("dark") === "true";
let userLeaves = JSON.parse(localStorage.getItem("leaves") || "{}");
let userDelays = JSON.parse(localStorage.getItem("delays") || "{}");
let userPerms = JSON.parse(localStorage.getItem("perms") || "{}");
let customColors = JSON.parse(localStorage.getItem("colors") || "{}");
let manualStats = JSON.parse(localStorage.getItem("manual") || "{}");
let selectedDateISO = null;

/* INIT */
const params = new URLSearchParams(window.location.search);
if (params.get("group")) {
  const map = { A: 0, B: 1, C: 2, D: 3, E: 4 };
  if (map[params.get("group").toUpperCase()] !== undefined) localStorage.setItem("group", map[params.get("group").toUpperCase()]);
}
groupSelect.value = localStorage.getItem("group") || "-1";
if (params.get("group")) groupSelect.disabled = true;

/* CORE FUNCTIONS */
function initColors() { colorKeys.forEach(k => { document.documentElement.style.setProperty(`--col-${k}`, customColors[k] || defaultColors[k]); }); }
function updateColor(key, val) { customColors[key] = val; localStorage.setItem("colors", JSON.stringify(customColors)); document.documentElement.style.setProperty(`--col-${key}`, val); render(); }
function resetColors() { customColors={}; localStorage.removeItem("colors"); initColors(); openSettings(); render(); }
function saveGroup() { localStorage.setItem("group", groupSelect.value); render(); }
function updateThemeColor(isDark) { const m=document.getElementById("meta-theme-color"); if(m) m.content=isDark?"#000000":"#f2f2f7"; }
function toggleLang() { lang=lang==="en"?"ar":"en"; localStorage.setItem("lang",lang); render(); }
function toggleDark() { dark=!dark; localStorage.setItem("dark",dark); document.body.classList.toggle("dark"); updateThemeColor(dark); }
function changeMonth(n) { currentDate.setMonth(currentDate.getMonth()+n); render(); }
function closeModal(id,e) { if(!e || e.target===e.currentTarget) document.getElementById(id).classList.remove("show"); }

/* DATA BACKUP & RESTORE */
function backupData() {
  const data = { leaves: userLeaves, delays: userDelays, perms: userPerms, manual: manualStats, colors: customColors, group: groupSelect.value, lang: lang, dark: dark };
  const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `myshifts_backup_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
}
function restoreData(input) {
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if(data.leaves) localStorage.setItem("leaves", JSON.stringify(data.leaves));
      if(data.delays) localStorage.setItem("delays", JSON.stringify(data.delays));
      if(data.perms) localStorage.setItem("perms", JSON.stringify(data.perms));
      if(data.manual) localStorage.setItem("manual", JSON.stringify(data.manual));
      if(data.colors) localStorage.setItem("colors", JSON.stringify(data.colors));
      if(data.group) localStorage.setItem("group", data.group);
      alert("Data restored successfully!");
      location.reload();
    } catch(err) { alert("Invalid Backup File"); }
  };
  reader.readAsText(file);
}

/* MANUAL STATS */
function saveManual() {
  manualStats.SL = parseInt(document.getElementById("manSL").value) || 0;
  manualStats.EL = parseInt(document.getElementById("manEL").value) || 0;
  manualStats.perm = parseFloat(document.getElementById("manPerm").value) || 0;
  localStorage.setItem("manual", JSON.stringify(manualStats)); render(); 
}

/* TRACKING */
function promptDelay() {
  if(!selectedDateISO) return;
  const mins = prompt(lang==="ar"?"ÿ£ÿØÿÆŸÑ ÿØŸÇÿßÿ¶ŸÇ ÿßŸÑÿ™ÿ£ÿÆŸäÿ±:":"Enter Delay (Minutes):", userDelays[selectedDateISO]||"");
  if(mins !== null) { const val = parseInt(mins); if(val>0) userDelays[selectedDateISO]=val; else delete userDelays[selectedDateISO]; localStorage.setItem("delays", JSON.stringify(userDelays)); document.getElementById("leaveModal").classList.remove("show"); render(); }
}
function promptPermission() {
  if(!selectedDateISO) return;
  const hrs = prompt(lang==="ar"?"ŸÉŸÖ ÿ≥ÿßÿπÿ© ÿßÿ≥ÿ™ÿ¶ÿ∞ÿßŸÜÿü (ŸÖŸÜ 12)":"Hours used? (from 12h):", userPerms[selectedDateISO]||"");
  if(hrs !== null) { const val = parseFloat(hrs); if(val>0) userPerms[selectedDateISO]=val; else delete userPerms[selectedDateISO]; localStorage.setItem("perms", JSON.stringify(userPerms)); document.getElementById("leaveModal").classList.remove("show"); render(); }
}
function clearTimeData(type) {
  if(!selectedDateISO) return;
  if(type==='delay') delete userDelays[selectedDateISO]; if(type==='perm') delete userPerms[selectedDateISO];
  localStorage.setItem("delays", JSON.stringify(userDelays)); localStorage.setItem("perms", JSON.stringify(userPerms));
  document.getElementById("leaveModal").classList.remove("show"); render();
}

/* SETTINGS & MODALS */
function openSettings() {
  // GENERATE COLOR PICKERS (Fixed Logic)
  const list = document.getElementById("colorList");
  list.innerHTML = "";
  colorKeys.forEach(k => {
    const c = customColors[k] || defaultColors[k];
    list.innerHTML += `
      <div class="color-row">
        <span>${statsLabels[lang][k]}</span>
        <input type="color" value="${c}" onchange="updateColor('${k}',this.value)">
      </div>`;
  });

  // LOAD MANUAL INPUTS
  document.getElementById("manSL").value = manualStats.SL || "";
  document.getElementById("manEL").value = manualStats.EL || "";
  document.getElementById("manPerm").value = manualStats.perm || "";
  
  document.getElementById("settingsModal").classList.add("show");
}

function showYearlyStats() {
  const selected=parseInt(groupSelect.value); if(selected===-1){alert("Select Group First"); return;}
  const year=currentDate.getFullYear(); const today=new Date(); today.setHours(0,0,0,0);
  let daysWorked=0, daysLeft=0, totalDelay=0, totalPerm=0;
  const stats={SL:0,VL:0,EL:0};
  const isLeap=(year%4===0&&year%100!==0)||(year%400===0); const totalDays=isLeap?366:365;

  for(let d=1; d<=totalDays; d++) {
    const date=new Date(year,0,d);
    if(date < appStartDate) continue; 

    const iso=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    let code="O";
    if(userLeaves[iso]) code=userLeaves[iso];
    else { const diff=Math.floor((date-referenceDate)/86400000); code=shiftCodes[((diff+selected+5)%5+5)%5]; }
    
    if(code!=="O") { if(date<today) daysWorked++; else daysLeft++; }
    if(stats[code]!==undefined) stats[code]++;
    if(userDelays[iso]) totalDelay += userDelays[iso];
    if(userPerms[iso]) totalPerm += userPerms[iso];
  }
  stats.SL += (manualStats.SL || 0); stats.EL += (manualStats.EL || 0);
  
  const dh=Math.floor(totalDelay/60), dm=totalDelay%60;
  document.getElementById("yearlyTitle").innerText = `${year} Report (From Jan 15)`;
  document.getElementById("daysWorkedVal").innerText = daysWorked;
  document.getElementById("daysLeftVal").innerText = daysLeft;
  document.getElementById("totalDelayVal").innerText = `${dh}h ${dm}m`;
  document.getElementById("totalPermVal").innerText = `${totalPerm}h`;
  document.getElementById("leaveStatsGrid").innerHTML = `
    <div class="stat-box" style="background:var(--col-SL)"><span class="stat-val">${stats.SL}</span><span class="stat-lbl">${statsLabels[lang].SL}</span></div>
    <div class="stat-box" style="background:var(--col-VL)"><span class="stat-val">${stats.VL}</span><span class="stat-lbl">${statsLabels[lang].VL}</span></div>
    <div class="stat-box" style="background:var(--col-EL)"><span class="stat-val">${stats.EL}</span><span class="stat-lbl">${statsLabels[lang].EL}</span></div>
  `;
  document.getElementById("yearlyModal").classList.add("show");
}

function openLeaveModal(iso,d) { if(parseInt(groupSelect.value)===-1)return; selectedDateISO=iso; document.getElementById("leaveModalTitle").innerText=`${d} - Edit`; document.getElementById("leaveModal").classList.add("show"); }
function setLeave(t) { if(!selectedDateISO)return; if(t===null)delete userLeaves[selectedDateISO]; else userLeaves[selectedDateISO]=t; localStorage.setItem("leaves",JSON.stringify(userLeaves)); document.getElementById("leaveModal").classList.remove("show"); render(); }
function toggleDatePicker() { document.getElementById("datePickerContainer").classList.add("show"); const m=document.getElementById("pickerMonth"),y=document.getElementById("pickerYear"); m.innerHTML=""; y.innerHTML=""; for(let i=0;i<12;i++)m.add(new Option(new Date(2000,i,1).toLocaleString(lang,{month:"short"}),i)); const cy=currentDate.getFullYear(); for(let i=cy-5;i<=cy+5;i++) y.add(new Option(i,i)); m.value=currentDate.getMonth(); y.value=cy; }
function applyDate() { currentDate=new Date(document.getElementById("pickerYear").value,document.getElementById("pickerMonth").value,1); document.getElementById("datePickerContainer").classList.remove("show"); render(); }

/* EXPORT */
function exportToCalendar() {
  const selected=parseInt(groupSelect.value); if(selected===-1){alert("Select Group");return;}
  const year=currentDate.getFullYear(), month=currentDate.getMonth(), daysInMonth=new Date(year,month+1,0).getDate();
  let ics="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyShifts//EN\n";
  const times={M:"070000/150000",A:"150000/230000",N:"230000/070000"}; 
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d); const iso=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    let code=userLeaves[iso]?userLeaves[iso]:shiftCodes[((Math.floor((date-referenceDate)/86400000)+selected+5)%5+5)%5];
    if(["O","SL","VL","EL"].includes(code))continue;
    if(!times[code]) continue; 
    const [s,e]=times[code].split('/');
    let dStart=iso.replace(/-/g,''); let dEnd=dStart;
    if(code==="N") { const nextDay=new Date(date); nextDay.setDate(date.getDate()+1); dEnd=`${nextDay.getFullYear()}${String(nextDay.getMonth()+1).padStart(2,'0')}${String(nextDay.getDate()).padStart(2,'0')}`; }
    ics+=`BEGIN:VEVENT\nSUMMARY:Shift ${code}\nDTSTART:${dStart}T${s}\nDTEND:${dEnd}T${e}\nEND:VEVENT\n`;
  }
  ics+="END:VCALENDAR";
  const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'})); link.download="shifts.ics"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
}

/* RENDER */
function render() {
  const year=currentDate.getFullYear(), month=currentDate.getMonth(), selected=parseInt(groupSelect.value);
  monthTitle.innerText=currentDate.toLocaleString(lang,{month:"long",year:"numeric"});
  const head=document.getElementById("daysHeader"); head.innerHTML=""; days[lang].forEach(d=>{const el=document.createElement("div");el.innerText=d.substring(0,3);head.appendChild(el);});
  const body=document.getElementById("calendarBody"); body.innerHTML="";
  const firstDay=new Date(year,month,1).getDay(), daysInMonth=new Date(year,month+1,0).getDate();
  const today=new Date(); today.setHours(0,0,0,0); const events=islamicEvents[year];
  const stats={M:0,A:0,N:0,SL:0,VL:0,EL:0};
  let monthPermUsed = 0;

  for(let i=0;i<firstDay;i++)body.appendChild(document.createElement("div"));
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(year,month,d); date.setHours(0,0,0,0);
    const iso=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let displayCode="O";
    if(selected!==-1){
      if(userLeaves[iso]) displayCode=userLeaves[iso];
      else displayCode=shiftCodes[((Math.floor((date-referenceDate)/86400000)+selected+5)%5+5)%5];
      if(stats[displayCode]!==undefined) stats[displayCode]++;
    }
    if(userPerms[iso]) monthPermUsed += userPerms[iso];

    let hName="",hClass=""; if(events){ if(iso>=events.ramadanStart&&iso<=events.ramadanEnd){hName="Ramadan";hClass="ramadan-tag";}else if(iso>=events.eidFitrStart&&iso<=events.eidFitrEnd){hName="Eid Fitr";hClass="eid-tag";}else if(iso===events.arafah){hName="Arafah";hClass="eid-tag";}else if(iso>=events.eidAdhaStart&&iso<=events.eidAdhaEnd){hName="Eid Adha";hClass="eid-tag";} }
    
    const cell=document.createElement("div"); cell.className=`day-cell ${displayCode}`;
    if(date.getTime()===today.getTime()) cell.classList.add("today");
    cell.onclick=()=>openLeaveModal(iso,d);
    
    let content=`<div class="date-num">${d}</div>`;
    if(selected!==-1 && displayCode!=="O") content+=`<div class="shift-text">${shiftShort[lang][displayCode]}</div>`;
    if(hName) content+=`<div class="holiday-bar ${hClass}">${hName}</div>`;
    
    let badges = "";
    if(userDelays[iso]) badges += `<div class="badge badge-delay">${userDelays[iso]}m</div>`;
    if(userPerms[iso]) badges += `<div class="badge badge-perm">${userPerms[iso]}h</div>`;
    if(badges) content += `<div class="badge-container">${badges}</div>`;
    cell.innerHTML=content; body.appendChild(cell);
  }
  
  const permBar = document.getElementById("permBar");
  if(selected!==-1) {
    permBar.style.display="flex";
    const manualP = parseFloat(manualStats.perm || 0);
    const left = 12 - monthPermUsed - manualP;
    document.getElementById("permLeft").innerText = `${left}h Remaining`;
    permBar.style.background = left < 0 ? "#ff3b30" : "#007AFF";
  } else permBar.style.display="none";

  const statsBar=document.getElementById("statsBar");
  if(selected!==-1){
    statsBar.style.display="flex";
    let html=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-M)"></div>${stats.M}</div><div class="stat-item"><div class="stat-dot" style="background:var(--col-A)"></div>${stats.A}</div><div class="stat-item"><div class="stat-dot" style="background:var(--col-N)"></div>${stats.N}</div>`;
    if(stats.SL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-SL)"></div>${stats.SL}</div>`;
    if(stats.VL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-VL)"></div>${stats.VL}</div>`;
    if(stats.EL>0)html+=`<div class="stat-item"><div class="stat-dot" style="background:var(--col-EL)"></div>${stats.EL}</div>`;
    statsBar.innerHTML=html;
  }else{statsBar.style.display="none";}
}

/* START */
if(dark)document.body.classList.add("dark");
initColors(); updateThemeColor(dark); render();
let tx=0, te=0; document.getElementById("calendarWrapper").addEventListener('touchstart',e=>tx=e.changedTouches[0].screenX); document.getElementById("calendarWrapper").addEventListener('touchend',e=>{te=e.changedTouches[0].screenX; if(te<tx-50)changeMonth(1); if(te>tx+50)changeMonth(-1);});
</script>
</body>
</html>
